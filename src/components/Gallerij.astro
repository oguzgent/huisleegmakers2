---
// Foto gallerij / carousel - Sanity CMS ready
const fotos = [
  { src: '/images/gallerij/woonkamer-voor.jpg', alt: 'Woonkamer voor ontruiming - vol met meubels, tapijt en persoonlijke spullen' },
  { src: '/images/gallerij/woonkamer-na.jpg', alt: 'Woonkamer na ontruiming - volledig leeg en bezemschoon opgeleverd door Huisleegmakers' },
  { src: '/images/gallerij/slaapkamer-voor.jpg', alt: 'Slaapkamer voor ontruiming - bed, kledingkast en ladekast met persoonlijke spullen' },
  { src: '/images/gallerij/slaapkamer-na.jpg', alt: 'Slaapkamer na ontruiming - volledig leeggeruimd en bezemschoon opgeleverd' },
  { src: '/images/gallerij/badkamer-voor.jpg', alt: 'Badkamer voor ontruiming - wasmachine, stoel en spullen rondom het bad' },
  { src: '/images/gallerij/badkamer-na.jpg', alt: 'Badkamer na ontruiming - leeg en schoon opgeleverd door Huisleegmakers' },
];

const carouselFotos = [...fotos, ...fotos];
const realCount = fotos.length;
---

<section id="gallerij" class="py-16 md:py-20 bg-white">
  <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8">
    <div class="text-center mb-10">
      <p class="text-sm font-semibold text-brand-600 uppercase tracking-widest mb-3">Ons werk</p>
      <h2 class="text-2xl sm:text-3xl md:text-4xl font-extrabold text-gray-900 tracking-tight font-display mb-4">Bekijk onze realisaties</h2>
      <p class="text-gray-500 max-w-xl mx-auto">Van eerste contact tot bezemschone oplevering. Bekijk enkele voorbeelden van ons werk.</p>
    </div>

    <!-- Carousel -->
    <div class="relative" role="region" aria-label="Foto galerij" aria-roledescription="carousel">
      <!-- Prev button -->
      <button id="gallery-prev" class="hidden md:flex absolute -left-4 lg:-left-6 top-1/2 -translate-y-1/2 z-10 w-10 h-10 rounded-full bg-white border border-gray-200 shadow-md items-center justify-center hover:bg-gray-50 hover:border-gray-300 transition-all" aria-label="Vorige foto">
        <svg class="w-4 h-4 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
      </button>

      <!-- Track wrapper -->
      <div class="overflow-hidden">
        <div id="gallery-track" class="flex gap-4" data-real-count={realCount}>
          {carouselFotos.map((foto, i) => (
            <div class="gallery-card flex-shrink-0 w-[260px] sm:w-[300px] md:w-[340px]" data-index={i}>
              <div class="aspect-[4/3] rounded-xl overflow-hidden bg-gray-100 border border-gray-100 shadow-sm relative group">
                <img
                  src={foto.src}
                  alt={foto.alt}
                  class="gallery-img w-full h-full object-cover group-hover:scale-105 transition-transform duration-500"
                  width="340"
                  height="255"
                  loading="lazy"
                />
                <span class:list={[
                  'absolute top-3 left-3 px-2.5 py-1 rounded-md text-xs font-semibold tracking-wide backdrop-blur-sm shadow-sm',
                  i % 2 === 0 ? 'bg-gray-900/60 text-white' : 'bg-brand-600/80 text-white'
                ]}>
                  {i % 2 === 0 ? 'Voor' : 'Na'}
                </span>
              </div>
            </div>
          ))}
        </div>
      </div>

      <!-- Next button -->
      <button id="gallery-next" class="hidden md:flex absolute -right-4 lg:-right-6 top-1/2 -translate-y-1/2 z-10 w-10 h-10 rounded-full bg-white border border-gray-200 shadow-md items-center justify-center hover:bg-gray-50 hover:border-gray-300 transition-all" aria-label="Volgende foto">
        <svg class="w-4 h-4 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
      </button>
    </div>

    <!-- Dots -->
    <div class="flex items-center justify-center gap-3 mt-5">
      {fotos.map((_, i) => (
        <button class="gallery-dot w-3 h-3 rounded-full bg-gray-300 transition-all duration-200 p-1 -m-1" data-index={i} aria-label={`Ga naar foto ${i + 1}`}></button>
      ))}
    </div>
  </div>
</section>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const track = document.getElementById('gallery-track') as HTMLElement | null;
    const prev = document.getElementById('gallery-prev') as HTMLButtonElement | null;
    const next = document.getElementById('gallery-next') as HTMLButtonElement | null;
    const dots = document.querySelectorAll('.gallery-dot') as NodeListOf<HTMLButtonElement>;
    const cards = document.querySelectorAll('.gallery-card') as NodeListOf<HTMLElement>;

    if (!track || cards.length === 0) return;

    const realCount = parseInt(track.dataset.realCount || '6');
    let currentIndex = 0;
    let isMoving = false;

    function getCardWidth(): number {
      return (cards[0]?.offsetWidth || 300) + 16;
    }

    function updateDots() {
      const dotIndex = ((currentIndex % realCount) + realCount) % realCount;
      dots.forEach((d, i) => {
        const isActive = i === dotIndex;
        d.classList.toggle('bg-brand-600', isActive);
        d.classList.toggle('w-6', isActive);
        d.classList.toggle('bg-gray-300', !isActive);
        d.classList.toggle('w-3', !isActive);
      });
    }

    function goTo(index: number, animate = true) {
      if (animate) {
        isMoving = true;
        track!.style.transition = 'transform 400ms ease';
      } else {
        track!.style.transition = 'none';
      }

      currentIndex = index;
      track!.style.transform = `translateX(-${index * getCardWidth()}px)`;

      if (!animate) {
        track!.offsetHeight; // force reflow
        isMoving = false;
      }

      updateDots();
    }

    // Na elke animatie: als we in de kloon-zone zijn, spring onzichtbaar terug
    track.addEventListener('transitionend', () => {
      isMoving = false;
      if (currentIndex >= realCount) {
        goTo(currentIndex - realCount, false);
      }
    });

    next?.addEventListener('click', () => {
      if (isMoving) return;
      goTo(currentIndex + 1);
    });

    prev?.addEventListener('click', () => {
      if (isMoving) return;
      if (currentIndex <= 0) {
        goTo(realCount, false);
        requestAnimationFrame(() => goTo(realCount - 1));
      } else {
        goTo(currentIndex - 1);
      }
    });

    dots.forEach(d => {
      d.addEventListener('click', () => {
        if (isMoving) return;
        const idx = parseInt(d.getAttribute('data-index') || '0');
        goTo(idx);
      });
    });

    // Touch/swipe support
    let touchStartX = 0;
    let touchDeltaX = 0;

    track.addEventListener('touchstart', (e) => {
      if (isMoving) return;
      touchStartX = e.touches[0].clientX;
      touchDeltaX = 0;
      track!.style.transition = 'none';
    }, { passive: true });

    track.addEventListener('touchmove', (e) => {
      touchDeltaX = e.touches[0].clientX - touchStartX;
      const offset = currentIndex * getCardWidth() - touchDeltaX;
      track!.style.transform = `translateX(-${offset}px)`;
    }, { passive: true });

    track.addEventListener('touchend', () => {
      const threshold = getCardWidth() / 4;
      if (touchDeltaX > threshold) {
        if (currentIndex <= 0) {
          goTo(realCount, false);
          requestAnimationFrame(() => goTo(realCount - 1));
        } else {
          goTo(currentIndex - 1);
        }
      } else if (touchDeltaX < -threshold) {
        goTo(currentIndex + 1);
      } else {
        goTo(currentIndex);
      }
    });

    window.addEventListener('resize', () => goTo(currentIndex, false));

    updateDots();
  });
</script>
